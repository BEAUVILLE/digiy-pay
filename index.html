<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>DIGIY PAY ‚ôæÔ∏è</title>
  <meta name="theme-color" content="#020617">

  <!-- ‚úÖ ICONS DIGIY PAY (GitHub Pages SAFE) -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png?v=1">
  <link rel="manifest" href="./site.webmanifest?v=1">

<style>
:root{
  --bg:#020617;--ok:#22c55e;--gold:#facc15;--text:#fff;--muted:#cbd5f5;
  --line:rgba(148,163,184,.22);--soft:rgba(2,6,23,.75);
}
*{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
body{
  min-height:100vh;display:flex;justify-content:center;align-items:center;
  background:
    radial-gradient(circle at top,rgba(34,197,94,.18),transparent 60%),
    radial-gradient(circle at bottom,rgba(250,204,21,.16),transparent 55%),
    linear-gradient(135deg,var(--bg),#064e3b);
  color:var(--text);padding:14px;
}
.card{
  width:min(560px,96vw);
  background:rgba(2,8,24,.96);
  border:1px solid rgba(19,78,74,.9);
  border-radius:22px;
  padding:18px;
  box-shadow:0 18px 45px rgba(0,0,0,.45);
}
.top{text-align:center}
h1{font-weight:950;color:var(--ok);letter-spacing:.04em}
.sub{margin-top:6px;color:#e5e7eb;font-weight:850;line-height:1.45}
.pill{
  display:inline-flex;gap:8px;align-items:center;
  margin-top:10px;padding:7px 12px;border-radius:999px;
  border:1px solid rgba(250,204,21,.55);
  background:rgba(250,204,21,.10);color:#fde68a;font-weight:950;font-size:13px;
}
.name{margin-top:14px;font-size:22px;font-weight:980;color:var(--gold);text-align:center}
.hint{margin-top:6px;color:var(--muted);font-weight:850;font-size:13px;line-height:1.55;text-align:center}

.panel{
  margin-top:14px;
  padding:14px;border-radius:18px;
  border:1px solid var(--line);
  background:rgba(2,6,23,.55);
}
.panel h2{font-size:13px;letter-spacing:.05em;text-transform:uppercase;color:#bbf7d0;font-weight:950}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
@media(max-width:560px){.grid{grid-template-columns:1fr}}
input{
  width:100%;
  padding:12px 12px;border-radius:14px;
  border:1px solid var(--line);
  background:var(--soft);color:#fff;
  font-weight:900;outline:none;
}
small{display:block;margin-top:6px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.4}
.btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{
  flex:1;
  padding:12px 14px;border-radius:999px;
  font-weight:980;display:flex;justify-content:center;align-items:center;
  border:1px solid rgba(34,197,94,.55);
  background:rgba(34,197,94,.18);color:#bbf7d0;
  cursor:pointer;user-select:none;
}
.btn.primary{background:linear-gradient(135deg,#22c55e,#16a34a);color:#022c22;border:none}
.btn.ghost{background:rgba(2,6,23,.65);border:1px solid var(--line);color:#e5e7eb}

.paybox{
  margin-top:14px;padding:14px;border-radius:18px;
  border:1px solid rgba(34,197,94,.55);
  background:rgba(34,197,94,.10);
}
.lbl{font-size:12px;color:#bbf7d0;font-weight:950;letter-spacing:.05em;text-transform:uppercase}
.big{margin-top:8px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end}
.nm{font-size:20px;font-weight:980;color:var(--gold)}
code{
  font-family:ui-monospace,monospace;
  background:rgba(2,6,23,.55);
  border:1px solid rgba(148,163,184,.22);
  padding:6px 10px;border-radius:12px;
  font-size:16px;font-weight:950;color:#ecfdf5;
}
.msg{
  margin-top:12px;padding:10px 12px;border-radius:16px;
  border:1px solid rgba(250,204,21,.35);
  background:rgba(250,204,21,.08);
  color:#fde68a;font-weight:950;font-size:13px;line-height:1.55;
}
.err{
  margin-top:12px;padding:10px 12px;border-radius:16px;
  border:1px solid rgba(248,113,113,.45);
  background:rgba(248,113,113,.10);
  color:#fecaca;font-weight:950;font-size:13px;line-height:1.55;
}
.foot{margin-top:12px;font-size:12px;color:var(--muted);font-weight:850;text-align:center}
</style>
</head>

<body>
<div class="card">

  <div class="top">
    <h1>DIGIY PAY ‚ôæÔ∏è</h1>
    <div class="sub">Paiement direct au pro ‚Ä¢ 0% commission</div>
    <div class="pill">‚úÖ Simple ‚Ä¢ Direct ‚Ä¢ Souverain</div>
  </div>

  <div id="proName" class="name">‚Äî</div>
  <div id="proHint" class="hint">Scanne un QR ou entre un code pro.</div>

  <!-- CHARGER PAR CODE -->
  <div class="panel">
    <h2>Charger (code / QR)</h2>
    <div class="grid">
      <div>
        <input id="codeInput" placeholder="Tester un code (ex: CHEZASTOU)" autocomplete="off">
        <small>QR attendu : <b>...?pro=CODE</b></small>
      </div>
      <div class="btnrow" style="margin-top:0">
        <button id="btnLoad" class="btn ghost" type="button">üîé Charger</button>
        <button id="btnManual" class="btn" type="button">‚úçÔ∏è Saisie manuelle</button>
      </div>
    </div>
    <div id="autoMsg" class="msg" style="display:none"></div>
    <div id="autoErr" class="err" style="display:none"></div>
  </div>

  <!-- SAISIE MANUELLE -->
  <div id="manualPanel" class="panel" style="display:none">
    <h2>Nom + Tel Wave (manuel)</h2>
    <div class="grid">
      <div>
        <input id="nameInput" placeholder="Nom du pro" autocomplete="off">
      </div>
      <div>
        <input id="phoneInput" placeholder="Tel Wave (22177...)" autocomplete="off">
      </div>
    </div>
    <div class="btnrow">
      <button id="btnShow" class="btn primary" type="button">‚úÖ Afficher</button>
      <button id="btnHide" class="btn ghost" type="button">‚Ü©Ô∏é Retour</button>
    </div>
    <div id="manualErr" class="err" style="display:none"></div>
  </div>

  <!-- CARTE PAIEMENT -->
  <div id="paybox" class="paybox" style="display:none">
    <div class="lbl">Paiement Wave</div>
    <div class="big">
      <div>
        <div style="font-size:12px;color:#bbf7d0;font-weight:950;margin-bottom:4px">Nom</div>
        <div id="payName" class="nm">‚Äî</div>
      </div>
      <div>
        <div style="font-size:12px;color:#bbf7d0;font-weight:950;margin-bottom:4px">T√©l√©phone</div>
        <code id="payPhone">‚Äî</code>
      </div>
    </div>
    <div class="btnrow">
      <button id="btnCopy" class="btn" type="button">üìã Copier</button>
      <a id="btnCall" class="btn ghost" href="#" style="text-decoration:none">üìû Appeler</a>
    </div>
    <div id="howto" class="msg" style="display:none"></div>
  </div>

  <div class="foot">Ouvre Wave ‚Üí Payer ‚Üí colle le num√©ro affich√©.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ‚úÖ FALLBACK TERRAIN */
const FALLBACK_PRO_NAME="ASTOU SOW";
const FALLBACK_WAVE_PHONE_DIGITS="221778765785";

/* ‚úÖ SUPABASE */
const SUPABASE_URL="https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* UI */
const proName=document.getElementById("proName");
const proHint=document.getElementById("proHint");
const codeInput=document.getElementById("codeInput");
const btnLoad=document.getElementById("btnLoad");
const btnManual=document.getElementById("btnManual");
const autoMsg=document.getElementById("autoMsg");
const autoErr=document.getElementById("autoErr");

const manualPanel=document.getElementById("manualPanel");
const nameInput=document.getElementById("nameInput");
const phoneInput=document.getElementById("phoneInput");
const btnShow=document.getElementById("btnShow");
const btnHide=document.getElementById("btnHide");
const manualErr=document.getElementById("manualErr");

const paybox=document.getElementById("paybox");
const payName=document.getElementById("payName");
const payPhone=document.getElementById("payPhone");
const btnCopy=document.getElementById("btnCopy");
const btnCall=document.getElementById("btnCall");
const howto=document.getElementById("howto");

function show(el,on=true){el.style.display=on?"":"none";}
function digitsOnly(v){return String(v||"").replace(/\D/g,"");}

function showPayCard(name, phoneDigits){
  const phone="+"+phoneDigits;
  proName.textContent=name;
  proHint.textContent="Paiement direct au pro ‚Ä¢ 0% commission";

  payName.textContent=name;
  payPhone.textContent=phone;
  btnCall.href="tel:"+phone;

  btnCopy.onclick=async()=>{
    try{await navigator.clipboard.writeText(phone);}
    catch(e){window.prompt("Copie :",phone);}
  };

  howto.innerHTML="üëâ Wave ‚Üí Payer ‚Üí colle <b>"+phone+"</b>";
  show(howto,true);
  show(paybox,true);
}

function openManual(prefillName,prefillPhone){
  show(manualPanel,true);
  nameInput.value=prefillName||"";
  phoneInput.value=prefillPhone||"";
}

btnManual.onclick=()=>openManual(FALLBACK_PRO_NAME,"+"+FALLBACK_WAVE_PHONE_DIGITS);
btnHide.onclick=()=>show(manualPanel,false);

btnShow.onclick=()=>{
  const n=(nameInput.value||"").trim();
  const p=digitsOnly(phoneInput.value);
  if(!n) return;
  if(p.length<9) return;
  show(manualPanel,false);
  showPayCard(n,p);
};

/* ‚úÖ LOAD BY CODE */
async function loadByCode(code){
  const cleaned=(code||"").trim().toUpperCase();
  if(!cleaned){
    showPayCard(FALLBACK_PRO_NAME,FALLBACK_WAVE_PHONE_DIGITS);
    return;
  }

  try{
    const {data}=await sb
      .from("digiy_pay_pro")
      .select("business_name,wave_phone,is_active")
      .eq("business_code",cleaned)
      .eq("is_active",true)
      .maybeSingle();

    if(!data){
      openManual(cleaned,"");
      return;
    }

    const phone=digitsOnly(data.wave_phone);
    showPayCard(data.business_name||cleaned,phone);

  }catch(e){
    openManual(cleaned,"");
  }
}

btnLoad.onclick=()=>loadByCode(codeInput.value);

const params=new URLSearchParams(location.search);
const boot=params.get("pro")||"CHEZASTOU";
codeInput.value=boot;
loadByCode(boot);
</script>

</body>
</html>
