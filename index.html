<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>DIGIY PAY ‚ôæÔ∏è</title>
<meta name="theme-color" content="#020617">
<style>
  :root{--bg:#020617;--card:#020818;--line:#134e4a;--ok:#22c55e;--gold:#facc15;--text:#fff;--muted:#cbd5f5;}
  *{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
  body{
    min-height:100vh;display:flex;justify-content:center;align-items:center;
    background:radial-gradient(circle at top,rgba(34,197,94,.18),transparent 60%),
               radial-gradient(circle at bottom,rgba(250,204,21,.16),transparent 55%),
               linear-gradient(135deg,var(--bg),#064e3b);
    color:var(--text);padding:14px;
  }
  .card{
    width:min(460px,96vw);
    background:rgba(2,8,24,.96);
    border:1px solid rgba(19,78,74,.9);
    border-radius:22px;
    padding:18px;
    box-shadow:0 18px 45px rgba(0,0,0,.45);
    text-align:center;
  }
  h1{font-weight:950;color:var(--ok);letter-spacing:.04em}
  .sub{margin-top:6px;color:#e5e7eb;font-weight:700;line-height:1.45}
  .pill{
    display:inline-flex;gap:8px;align-items:center;
    margin-top:10px;padding:7px 12px;border-radius:999px;
    border:1px solid rgba(250,204,21,.55);
    background:rgba(250,204,21,.10);color:#fde68a;font-weight:900;font-size:13px;
  }
  .name{margin-top:14px;font-size:20px;font-weight:950;color:var(--gold)}
  .muted{margin-top:6px;color:var(--muted);font-weight:750;font-size:13px;line-height:1.45}
  .row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  input{
    flex:1;min-width:180px;
    padding:12px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(2,6,23,.75);color:#fff;
    font-weight:900;outline:none;
  }
  .btn{
    width:100%;
    margin-top:14px;
    padding:12px 14px;border-radius:999px;
    font-weight:950;text-decoration:none;display:flex;justify-content:center;align-items:center;
    border:1px solid rgba(34,197,94,.55);
    background:rgba(34,197,94,.18);color:#bbf7d0;
    cursor:pointer;
  }
  .btn.primary{
    background:linear-gradient(135deg,#22c55e,#16a34a);
    color:#022c22;border:none;
  }
  .foot{margin-top:12px;font-size:12px;color:var(--muted);font-weight:800}
</style>
</head>
<body>

<div class="card">
  <h1>DIGIY PAY ‚ôæÔ∏è</h1>
  <div class="sub">Paiement direct au professionnel ‚Ä¢ DIGIY = 0% commission</div>
  <div class="pill">‚úÖ Simple ‚Ä¢ Direct ‚Ä¢ Souverain</div>

  <div id="proName" class="name">Chargement‚Ä¶</div>
  <div id="proHint" class="muted"></div>

  <div class="row">
    <input id="codeInput" placeholder="Tester un code (ex: CHEZASTOU)" autocomplete="off">
    <button id="btnLoad" class="btn" type="button" style="width:auto;min-width:120px">üîé Charger</button>
  </div>

  <a id="waveBtn" class="btn primary" target="_blank" rel="noopener noreferrer" style="display:none">
    üí∞ Payer avec Wave
  </a>

  <div class="foot">Si tu arrives ici sans code, scanne le QR du pro.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const proName = document.getElementById("proName");
  const proHint = document.getElementById("proHint");
  const waveBtn = document.getElementById("waveBtn");
  const codeInput = document.getElementById("codeInput");

  function getCodeFromUrl(){
    const p = new URLSearchParams(window.location.search);
    return (p.get("pro") || p.get("code") || "").trim().toUpperCase();
  }

  function setUrlCode(code){
    const url = new URL(window.location.href);
    url.searchParams.set("pro", code);
    history.replaceState({}, "", url.toString());
  }

  async function loadPro(code){
    waveBtn.style.display = "none";
    proHint.textContent = "";

    if(!code){
      proName.textContent = "QR invalide";
      proHint.textContent = "Ouvre avec ?pro=CHEZASTOU (ou scanne un QR).";
      return;
    }

    proName.textContent = "Chargement‚Ä¶";
    proHint.textContent = "Code : " + code;

    const { data, error } = await sb
      .from("digiy_pay_pro")
      .select("business_code,business_name,wave_phone,is_active")
      .eq("business_code", code)
      .eq("is_active", true)
      .maybeSingle();

    if (error){
      proName.textContent = "Erreur Supabase";
      proHint.textContent = error.message || "Erreur inconnue";
      return;
    }

    if(!data){
      proName.textContent = "Professionnel introuvable";
      proHint.textContent = "V√©rifie le code (ex: CHEZASTOU) ou l‚Äôactivation du pro.";
      return;
    }

    proName.textContent = data.business_name || data.business_code;
    const phone = String(data.wave_phone || "").replace(/\D/g,"");

    if(phone.length < 9){
      proHint.textContent = "Wave non configur√© pour ce pro.";
      return;
    }

    waveBtn.href = "https://wave.com/pay/" + phone;
    waveBtn.style.display = "flex";
    proHint.textContent = "Paiement direct ‚Ä¢ Code : " + data.business_code;
  }

  document.getElementById("btnLoad").addEventListener("click", ()=>{
    const code = (codeInput.value || "").trim().toUpperCase();
    if(code) setUrlCode(code);
    loadPro(code);
  });

  codeInput.addEventListener("keydown",(e)=>{
    if(e.key === "Enter") document.getElementById("btnLoad").click();
  });

  // boot (Astou par d√©faut)
  let code = getCodeFromUrl();
  if(!code) code = "CHEZASTOU";
  codeInput.value = code;
  loadPro(code);
</script>

</body>
</html>
