<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>DIGIY PAY â€” Dashboard Temps RÃ©el</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- Chart.js pour le graphique -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#050814;
      --bg-soft:#0b1220;
      --card:#020617;
      --card-soft:#0f172a;
      --accent:#facc15;      /* or / gold */
      --accent-soft:#fde68a;
      --danger:#ef4444;
      --ok:#22c55e;
      --muted:#9ca3af;
      --ink:#f9fafb;
      --line:#1f2937;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body{
      background:radial-gradient(circle at top, #1f2937 0, #020617 42%, #000 100%);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:1400px;
      margin:12px;
      border-radius:24px;
      background:radial-gradient(circle at top left, rgba(250,204,21,0.06), transparent 50%), #020617;
      box-shadow:0 24px 80px rgba(0,0,0,0.65);
      overflow:hidden;
      display:flex;
      flex-direction:row;
      border:1px solid rgba(148,163,184,0.25);
    }

    /* ========== SIDEBAR ========== */
    .sidebar{
      width:260px;
      padding:20px 18px;
      background:linear-gradient(180deg, #020617 0%, #020617 45%, #030712 100%);
      border-right:1px solid rgba(148,163,184,0.18);
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .logo-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-badge{
      width:36px;
      height:36px;
      border-radius:14px;
      background:radial-gradient(circle at 20% 0%, #facc15, #eab308 40%, #92400e 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      letter-spacing:1px;
      color:#111827;
      font-size:16px;
      box-shadow:0 0 0 1px rgba(250,204,21,0.4), 0 12px 30px rgba(0,0,0,0.8);
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-text span:first-child{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:var(--muted);
    }
    .brand-text span:last-child{
      font-size:15px;
      font-weight:600;
      color:var(--accent-soft);
    }

    .sidebar-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--muted);
      margin-top:6px;
    }

    .merchant-card{
      margin-top:6px;
      padding:10px 10px;
      border-radius:14px;
      background:radial-gradient(circle at top left, rgba(250,204,21,0.08), rgba(15,23,42,0.95));
      border:1px solid rgba(148,163,184,0.4);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .merchant-name{
      font-size:14px;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .merchant-tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.4);
      color:var(--muted);
    }
    .merchant-id{
      font-size:11px;
      color:var(--muted);
      letter-spacing:0.08em;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.25);
      font-size:11px;
      color:var(--muted);
    }
    .status-dot{
      width:9px;
      height:9px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%, #bbf7d0, #22c55e);
      box-shadow:0 0 0 2px rgba(34,197,94,0.35);
    }

    .box-filters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .box-filter-btn{
      flex:0 1 48%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.95);
      color:var(--muted);
      font-size:11px;
      padding:6px 8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:all 0.16s ease-out;
    }
    .box-filter-btn span{
      font-weight:500;
    }
    .box-filter-btn small{
      font-size:10px;
      opacity:0.8;
    }
    .box-filter-btn.active{
      border-color:var(--accent);
      background:radial-gradient(circle at top left, rgba(250,204,21,0.22), #020617);
      color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(250,204,21,0.7);
    }

    .info-box{
      margin-top:8px;
      padding:8px 9px;
      border-radius:12px;
      border:1px dashed rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.9);
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }
    .info-box b{
      color:var(--accent-soft);
      font-weight:600;
    }

    .simu-btn{
      margin-top:4px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.95);
      color:var(--ink);
      font-size:12px;
      padding:8px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:all 0.16s ease-out;
    }
    .simu-btn:hover{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(250,204,21,0.5);
    }

    /* ========== MAIN LAYOUT ========== */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:18px 18px 16px 18px;
      gap:14px;
      background:radial-gradient(circle at top, rgba(250,204,21,0.08), rgba(15,23,42,1));
    }

    .main-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .title-block h1{
      font-size:18px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .title-block p{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
    }

    .time-range{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--muted);
    }
    .chip{
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.95);
    }

    .top-cards{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .card{
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.32);
      background:radial-gradient(circle at top left, rgba(15,23,42,1), rgba(15,23,42,0.95));
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:2px;
      min-height:72px;
    }
    .card-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--muted);
    }
    .card-value{
      font-size:20px;
      font-weight:600;
      margin-top:4px;
    }
    .card-sub{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }
    .trend{
      font-size:11px;
      margin-top:2px;
    }
    .trend.positive{
      color:var(--ok);
    }
    .trend.negative{
      color:var(--danger);
    }

    .content-row{
      display:grid;
      grid-template-columns: minmax(0,2.1fr) minmax(0,1.4fr);
      gap:12px;
      min-height:0;
      flex:1;
    }

    .panel{
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.3);
      background:radial-gradient(circle at top left, rgba(15,23,42,1), rgba(15,23,42,0.98));
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .panel-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--muted);
    }
    .panel-header span strong{
      color:var(--accent-soft);
    }

    .chart-wrap{
      flex:1;
      min-height:220px;
      position:relative;
    }

    .tickets-list{
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.8);
      background:radial-gradient(circle at top, rgba(15,23,42,1), rgba(15,23,42,0.98));
      padding:4px 0;
      flex:1;
      min-height:0;
      overflow:auto;
    }

    .ticket-row{
      display:flex;
      padding:6px 10px;
      gap:8px;
      justify-content:space-between;
      align-items:flex-start;
      border-bottom:1px solid rgba(31,41,55,0.9);
      font-size:12px;
    }
    .ticket-main{
      display:flex;
      flex-direction:column;
      gap:1px;
    }
    .ticket-amount{
      font-weight:600;
    }
    .ticket-sub{
      font-size:11px;
      color:var(--muted);
    }
    .ticket-right{
      text-align:right;
      font-size:11px;
      color:var(--muted);
    }
    .ticket-box{
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.12em;
    }

    .pill-pay{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      padding:2px 7px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.12em;
    }

    .pill-pay[data-method="cash"]{
      border-color:rgba(163,230,53,0.8);
      color:#bbf7d0;
    }
    .pill-pay[data-method="wave"]{
      border-color:rgba(59,130,246,0.8);
      color:#bfdbfe;
    }
    .pill-pay[data-method="om"]{
      border-color:rgba(249,115,22,0.9);
      color:#fed7aa;
    }
    .pill-pay[data-method="card"]{
      border-color:rgba(248,250,252,0.9);
      color:#e5e7eb;
    }

    .empty-state{
      padding:14px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width:1024px){
      .app{
        flex-direction:column;
      }
      .sidebar{
        width:100%;
        flex-direction:row;
        align-items:flex-start;
        justify-content:space-between;
      }
      .box-filters{
        max-width:280px;
      }
    }

    @media (max-width:768px){
      .sidebar{
        flex-direction:column;
      }
      .content-row{
        grid-template-columns:1fr;
      }
      .top-cards{
        grid-template-columns:repeat(2, minmax(0,1fr));
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- ========== SIDEBAR ========== -->
  <aside class="sidebar">
    <div class="logo-row">
      <div class="logo-badge">DG</div>
      <div class="brand-text">
        <span>DIGIY PAY</span>
        <span>Dashboard Temps RÃ©el</span>
      </div>
    </div>

    <div>
      <div class="sidebar-section-title">CommerÃ§ant / Token</div>
      <div class="merchant-card">
        <div class="merchant-name">
          <span id="uiMerchantName">â€”</span>
          <span class="merchant-tag">LIVE PULSE</span>
        </div>
        <div class="merchant-id" id="uiMerchantId">Merchant: â€”</div>
        <div style="margin-top:6px;">
          <span class="pill">
            <span class="status-dot" id="uiStatusDot"></span>
            <span id="uiStatusLabel">En attente du fluxâ€¦</span>
          </span>
        </div>
      </div>
    </div>

    <div>
      <div class="sidebar-section-title">Filtre par box</div>
      <div class="box-filters">
        <button class="box-filter-btn active" data-box="ALL">
          <span>ALL</span><small>Vue globale</small>
        </button>
        <button class="box-filter-btn" data-box="POS-1">
          <span>POS-1</span><small>Caisse 1</small>
        </button>
        <button class="box-filter-btn" data-box="POS-2">
          <span>POS-2</span><small>Caisse 2</small>
        </button>
        <button class="box-filter-btn" data-box="DRIVER-1">
          <span>DRIVER</span><small>Courses</small>
        </button>
        <button class="box-filter-btn" data-box="MARKET-1">
          <span>MARKET</span><small>Boutique</small>
        </button>
      </div>
    </div>

    <div>
      <div class="sidebar-section-title">Infos / Test</div>
      <div class="info-box">
        <b>Tip :</b> ce dashboard Ã©coute PULSE sur<br>
        <code id="uiPulseUrl" style="font-size:10px;"></code><br><br>
        Envoie tes encaissements via<br>
        <code style="font-size:10px;">POST /event</code><br>
        avec <code>merchant</code>, <code>box</code>, <code>total</code>, <code>pay_method</code>.
      </div>
      <button class="simu-btn" id="btnSimu">
        <span>âš¡ Simuler une vente</span>
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <main class="main">
    <header class="main-header">
      <div class="title-block">
        <h1>DIGIY PAY â€” PANEL CA & TICKETS</h1>
        <p>Vue temps rÃ©el des encaissements (PULSE API â†’ Dashboard PAY).</p>
      </div>
      <div class="time-range">
        <span class="chip">Aujourdâ€™hui</span>
        <span class="chip">Filtre box actif</span>
      </div>
    </header>

    <!-- Top KPI cards -->
    <section class="top-cards">
      <article class="card">
        <div class="card-title">CA total (filtre actif)</div>
        <div class="card-value" id="uiCA">0 FCFA</div>
        <div class="card-sub">Tous modes de paiement</div>
      </article>
      <article class="card">
        <div class="card-title">Tickets</div>
        <div class="card-value" id="uiTickets">0</div>
        <div class="card-sub">Tickets encaissÃ©s</div>
      </article>
      <article class="card">
        <div class="card-title">Panier moyen</div>
        <div class="card-value" id="uiAvg">0 FCFA</div>
        <div class="card-sub">CA / nombre de tickets</div>
      </article>
      <article class="card">
        <div class="card-title">Dernier encaissement</div>
        <div class="card-value" id="uiLastPay">â€”</div>
        <div class="card-sub" id="uiLastMeta">En attenteâ€¦</div>
      </article>
    </section>

    <!-- Graph + tickets -->
    <section class="content-row">
      <!-- Graph & stats paiement -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">RÃ©partition par mode de paiement</div>
          <span style="font-size:11px;color:var(--muted);">
            Cash / Wave / OM / Card Â· <strong id="uiBoxFilterLabel">Filtre : ALL</strong>
          </span>
        </div>
        <div class="chart-wrap">
          <canvas id="payChart"></canvas>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px;font-size:11px;color:var(--muted);flex-wrap:wrap;">
          <span class="pill-pay" data-method="cash">ðŸ’µ Cash&nbsp;<span id="statCash">0</span></span>
          <span class="pill-pay" data-method="wave">ðŸŒŠ Wave&nbsp;<span id="statWave">0</span></span>
          <span class="pill-pay" data-method="om">ðŸŸ  OM&nbsp;<span id="statOM">0</span></span>
          <span class="pill-pay" data-method="card">ðŸ’³ Card&nbsp;<span id="statCard">0</span></span>
        </div>
      </section>

      <!-- Tickets temps rÃ©el -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">Tickets en temps rÃ©el</div>
          <span style="font-size:11px;color:var(--muted);">
            Derniers encaissements PULSE
          </span>
        </div>
        <div class="tickets-list" id="ticketList">
          <div class="empty-state">
            En attente de ton premier encaissement DIGIY PAYâ€¦<br>
            Lance une vente pour voir le flux arriver en live.
          </div>
        </div>
      </section>
    </section>
  </main>
</div>

<script>
/**
 * ================================
 * CONFIG Ã€ ADAPTER
 * ================================
 */
const PULSE_URL = "http://127.0.0.1:3200"; // â† adapte si PULSE est en ligne
const MERCHANT_TOKEN = "ASTOU-SN-001";    // â† ton token commerÃ§ant rÃ©el

/**
 * ================================
 * Ã‰TAT GLOBAL
 * ================================
 */
const STATE = {
  events: [],       // tous les events reÃ§us
  activeBox: "ALL", // filtre box
  chart: null
};

const STATS = {
  cash: 0,
  wave: 0,
  om: 0,
  card: 0
};

/**
 * ================================
 * INIT UI
 * ================================
 */
document.getElementById("uiMerchantName").textContent = "DIGIY PAY";
document.getElementById("uiMerchantId").textContent = "Merchant: " + MERCHANT_TOKEN;
document.getElementById("uiPulseUrl").textContent = PULSE_URL + "/events?m=" + MERCHANT_TOKEN;

/**
 * ================================
 * OUTILS
 * ================================
 */
function formatFCFA(amount){
  if (!amount) return "0 FCFA";
  return amount.toLocaleString("fr-FR") + " FCFA";
}

function updateStatus(online){
  const dot = document.getElementById("uiStatusDot");
  const label = document.getElementById("uiStatusLabel");
  if(online){
    dot.style.background = "radial-gradient(circle at 30% 0%, #bbf7d0, #22c55e)";
    dot.style.boxShadow = "0 0 0 2px rgba(34,197,94,0.35)";
    label.textContent = "Flux PULSE connectÃ©";
  }else{
    dot.style.background = "radial-gradient(circle at 30% 0%, #fee2e2, #ef4444)";
    dot.style.boxShadow = "0 0 0 2px rgba(248,113,113,0.5)";
    label.textContent = "DÃ©connectÃ© / en attenteâ€¦";
  }
}

/**
 * ================================
 * GESTION DES STATISTIQUES
 * ================================
 */
function recomputeStats(){
  // reset
  STATS.cash = STATS.wave = STATS.om = STATS.card = 0;
  let total = 0;
  let count = 0;

  const filterBox = STATE.activeBox;

  STATE.events.forEach(ev => {
    if (ev.type !== "sale") return;
    if (filterBox !== "ALL" && ev.box !== filterBox) return;

    const t = Number(ev.total) || 0;
    total += t;
    count++;

    const m = (ev.pay_method || "").toLowerCase();
    if (STATS[m] !== undefined) {
      STATS[m] += t;
    }
  });

  // CA, tickets, panier moyen
  document.getElementById("uiCA").textContent = formatFCFA(total);
  document.getElementById("uiTickets").textContent = count.toString();
  const avg = count ? Math.round(total / count) : 0;
  document.getElementById("uiAvg").textContent = formatFCFA(avg);

  // Stats par mode
  document.getElementById("statCash").textContent = STATS.cash.toLocaleString("fr-FR");
  document.getElementById("statWave").textContent = STATS.wave.toLocaleString("fr-FR");
  document.getElementById("statOM").textContent = STATS.om.toLocaleString("fr-FR");
  document.getElementById("statCard").textContent = STATS.card.toLocaleString("fr-FR");

  // Mettre Ã  jour le graphique
  updateChart();
}

/**
 * ================================
 * GRAPHIQUE CHART.JS
 * ================================
 */
function initChart(){
  const ctx = document.getElementById("payChart").getContext("2d");
  STATE.chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Cash", "Wave", "OM", "Card"],
      datasets: [{
        label: "CA par mode (FCFA)",
        data: [0, 0, 0, 0],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          grid: { color:"rgba(55,65,81,0.5)" },
          ticks: { color:"#e5e7eb", font:{ size:11 } }
        },
        y: {
          grid: { color:"rgba(55,65,81,0.5)" },
          ticks: { color:"#9ca3af", font:{ size:11 } }
        }
      },
      plugins:{
        legend:{ labels:{ color:"#e5e7eb", font:{ size:11 } } }
      }
    }
  });
}

function updateChart(){
  if (!STATE.chart) return;
  STATE.chart.data.datasets[0].data = [
    STATS.cash,
    STATS.wave,
    STATS.om,
    STATS.card
  ];
  STATE.chart.update();
}

/**
 * ================================
 * TICKETS TEMPS RÃ‰EL
 * ================================
 */
function renderTickets(){
  const list = document.getElementById("ticketList");
  list.innerHTML = "";

  const filterBox = STATE.activeBox;
  const filtered = STATE.events
    .filter(ev => ev.type === "sale")
    .filter(ev => filterBox === "ALL" || ev.box === filterBox)
    // tri par date (at) pour Ãªtre robuste mÃªme si id est une string
    .sort((a,b) => new Date(b.at || 0) - new Date(a.at || 0));

  if (!filtered.length){
    const empty = document.createElement("div");
    empty.className = "empty-state";
    empty.textContent = "Aucun ticket pour lâ€™instant sur ce filtre box.";
    list.appendChild(empty);
    return;
  }

  filtered.forEach(ev => {
    const row = document.createElement("div");
    row.className = "ticket-row";

    const m = (ev.pay_method || "").toLowerCase();
    const methodLabel = m === "cash" ? "Cash" :
                        m === "wave" ? "Wave" :
                        m === "om" ? "Orange Money" :
                        m === "card" ? "Carte" : (m || "").toUpperCase();
    const amount = formatFCFA(Number(ev.total) || 0);

    const time = ev.at ? new Date(ev.at) : new Date();
    const timeStr = time.toLocaleTimeString("fr-FR",{ hour:"2-digit", minute:"2-digit", second:"2-digit" });

    const box = ev.box || "â€”";

    const main = document.createElement("div");
    main.className = "ticket-main";
    const title = document.createElement("div");
    title.className = "ticket-amount";
    title.textContent = amount;
    const sub = document.createElement("div");
    sub.className = "ticket-sub";
    sub.textContent = ev.id ? `Ticket ${ev.id}` : "Ticket";

    main.appendChild(title);
    main.appendChild(sub);

    const mid = document.createElement("div");
    const pill = document.createElement("span");
    pill.className = "pill-pay";
    pill.setAttribute("data-method", m || "");
    pill.textContent = methodLabel;
    mid.appendChild(pill);

    const right = document.createElement("div");
    right.className = "ticket-right";
    const spanTime = document.createElement("div");
    spanTime.textContent = timeStr;
    const spanBox = document.createElement("div");
    spanBox.className = "ticket-box";
    spanBox.textContent = box;
    right.appendChild(spanTime);
    right.appendChild(spanBox);

    row.appendChild(main);
    row.appendChild(mid);
    row.appendChild(right);

    list.appendChild(row);
  });
}

/**
 * ================================
 * NOUVEL EVENT REÃ‡U
 * ================================
 */
function handleIncomingEvent(ev){
  // normaliser
  if (!ev.merchant) ev.merchant = MERCHANT_TOKEN;
  if (!ev.type) ev.type = "sale";
  if (!ev.pay_method) ev.pay_method = "cash";
  if (!ev.box) ev.box = "POS-1";
  if (!ev.at) ev.at = new Date().toISOString();
  if (!ev.id) ev.id = Date.now();

  STATE.events.push(ev);

  // Dernier encaissement
  document.getElementById("uiLastPay").textContent = formatFCFA(Number(ev.total) || 0);
  document.getElementById("uiLastMeta").textContent =
    (ev.pay_method || "").toUpperCase() + " Â· Box " + (ev.box || "â€”");

  recomputeStats();
  renderTickets();
}

/**
 * ================================
 * CONNECTER AU FLUX PULSE (SSE)
 * ================================
 */
function connectSSE(){
  try{
    const url = PULSE_URL + "/events?m=" + encodeURIComponent(MERCHANT_TOKEN);
    const es = new EventSource(url);

    es.onopen = () => {
      updateStatus(true);
    };

    es.onerror = () => {
      updateStatus(false);
      // EventSource va retenter tout seul cÃ´tÃ© navigateur
    };

    es.onmessage = (e) => {
      try{
        const data = JSON.parse(e.data);
        handleIncomingEvent(data);
      }catch(err){
        console.error("Event SSE invalide:", err);
      }
    };
  }catch(err){
    console.error("Erreur SSE:", err);
    updateStatus(false);
  }
}

/**
 * ================================
 * FILTRE BOX
 * ================================
 */
function setupBoxFilters(){
  const buttons = document.querySelectorAll(".box-filter-btn");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const box = btn.getAttribute("data-box");
      STATE.activeBox = box;
      document.getElementById("uiBoxFilterLabel").textContent = "Filtre : " + box;
      recomputeStats();
      renderTickets();
    });
  });
}

/**
 * ================================
 * BOUTON SIMULATION
 * ================================
 */
function setupSimu(){
  const btn = document.getElementById("btnSimu");
  btn.addEventListener("click", () => {
    const modes = ["cash","wave","om","card"];
    const boxes = ["POS-1","POS-2","DRIVER-1","MARKET-1"];
    const m = modes[Math.floor(Math.random()*modes.length)];
    const b = boxes[Math.floor(Math.random()*boxes.length)];
    const total = [2000,3000,5000,6000,8000,10000,15000][Math.floor(Math.random()*7)];
    const fake = {
      merchant: MERCHANT_TOKEN,
      box: b,
      type: "sale",
      total,
      pay_method: m,
      items:[{ name:"Produit test", qty:1, price:total }],
      at: new Date().toISOString()
    };
    handleIncomingEvent(fake);
  });
}

/**
 * ================================
 * DÃ‰MARRAGE
 * ================================
 */
window.addEventListener("load", () => {
  initChart();
  setupBoxFilters();
  setupSimu();
  connectSSE();
});
</script>
</body>
</html>
