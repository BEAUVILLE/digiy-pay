<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>DIGIY PAY ‚ôæÔ∏è</title>
<meta name="theme-color" content="#020617">
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.ico">

<style>
  :root{
    --bg:#020617;--card:#020818;--line:rgba(19,78,74,.9);
    --ok:#22c55e;--gold:#facc15;--text:#fff;--muted:#cbd5f5;
    --danger:#fb7185;
  }
  *{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
  body{
    min-height:100vh;display:flex;justify-content:center;align-items:center;
    background:
      radial-gradient(circle at top,rgba(34,197,94,.18),transparent 60%),
      radial-gradient(circle at bottom,rgba(250,204,21,.16),transparent 55%),
      linear-gradient(135deg,var(--bg),#064e3b);
    color:var(--text);padding:14px;
  }
  .card{
    width:min(520px,96vw);
    background:rgba(2,8,24,.96);
    border:1px solid var(--line);
    border-radius:22px;
    padding:18px;
    box-shadow:0 18px 45px rgba(0,0,0,.45);
    text-align:center;
  }
  h1{font-weight:950;color:var(--ok);letter-spacing:.04em}
  .sub{margin-top:6px;color:#e5e7eb;font-weight:750;line-height:1.45}
  .pill{
    display:inline-flex;gap:8px;align-items:center;
    margin-top:10px;padding:7px 12px;border-radius:999px;
    border:1px solid rgba(250,204,21,.55);
    background:rgba(250,204,21,.10);color:#fde68a;font-weight:950;font-size:13px;
  }

  .name{margin-top:14px;font-size:22px;font-weight:980;color:var(--gold)}
  .hint{margin-top:6px;color:var(--muted);font-weight:800;font-size:13px;line-height:1.45}

  .paybox{
    margin-top:14px;
    padding:14px;
    border-radius:18px;
    border:1px solid rgba(34,197,94,.55);
    background:rgba(34,197,94,.10);
    text-align:left;
  }
  .label{font-size:12px;color:#bbf7d0;font-weight:950;letter-spacing:.04em;text-transform:uppercase}
  .tel{
    margin-top:6px;
    font-size:22px;
    font-weight:980;
    color:#ecfdf5;
    letter-spacing:.3px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    flex-wrap:wrap;
  }
  .tel code{
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.22);
    padding:6px 10px;border-radius:12px;
  }

  .row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  input{
    flex:1;min-width:180px;
    padding:12px 12px;border-radius:14px;
    border:1px solid rgba(148,163,184,.25);
    background:rgba(2,6,23,.75);color:#fff;
    font-weight:900;outline:none;
  }

  .btn{
    width:100%;
    padding:12px 14px;border-radius:999px;
    font-weight:980;text-decoration:none;display:flex;justify-content:center;align-items:center;
    border:1px solid rgba(34,197,94,.55);
    background:rgba(34,197,94,.18);color:#bbf7d0;
    cursor:pointer;user-select:none;
  }
  .btn.primary{
    background:linear-gradient(135deg,#22c55e,#16a34a);
    color:#022c22;border:none;
  }
  .btn.ghost{
    background:rgba(2,6,23,.65);
    border:1px solid rgba(148,163,184,.25);
    color:#e5e7eb;
  }
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  @media(max-width:520px){.actions{grid-template-columns:1fr}}

  .msg{
    margin-top:12px;
    padding:10px 12px;border-radius:16px;
    border:1px solid rgba(250,204,21,.35);
    background:rgba(250,204,21,.08);
    color:#fde68a;font-weight:850;font-size:13px;line-height:1.5;
  }
  .err{
    margin-top:12px;
    padding:10px 12px;border-radius:16px;
    border:1px solid rgba(251,113,133,.55);
    background:rgba(251,113,133,.10);
    color:#fecaca;font-weight:900;font-size:13px;line-height:1.5;
  }
  .foot{margin-top:12px;font-size:12px;color:var(--muted);font-weight:850}
</style>
</head>
<body>

<div class="card">
  <h1>DIGIY PAY ‚ôæÔ∏è</h1>
  <div class="sub">Paiement direct au professionnel ‚Ä¢ DIGIY = 0% commission</div>
  <div class="pill">‚úÖ Simple ‚Ä¢ Direct ‚Ä¢ Souverain</div>

  <div id="proName" class="name">Chargement‚Ä¶</div>
  <div id="proHint" class="hint"></div>

  <div id="paybox" class="paybox" style="display:none">
    <div class="label">Num√©ro Wave du pro</div>
    <div class="tel">
      <code id="proPhone">‚Äî</code>
      <span style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnCopy" class="btn ghost" type="button" style="width:auto">üìã Copier</button>
        <a id="btnCall" class="btn ghost" style="width:auto" href="#">üìû Appeler</a>
      </span>
    </div>
  </div>

  <div class="row">
    <input id="codeInput" placeholder="Tester un code (ex: CHEZASTOU)" autocomplete="off">
    <button id="btnLoad" class="btn ghost" type="button" style="width:auto;min-width:120px">üîé Charger</button>
  </div>

  <div id="howto" class="msg" style="display:none"></div>
  <div id="err" class="err" style="display:none"></div>

  <div class="foot">Si tu arrives ici sans code, scanne le QR du pro.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const proName  = document.getElementById("proName");
  const proHint  = document.getElementById("proHint");
  const codeInput= document.getElementById("codeInput");
  const btnLoad  = document.getElementById("btnLoad");

  const paybox   = document.getElementById("paybox");
  const pro hookup = null;
  const proPhoneEl = document.getElementById("proPhone");
  const btnCopy  = document.getElementById("btnCopy");
  const btnCall  = document.getElementById("btnCall");
  const howto    = document.getElementById("howto");
  const errBox   = document.getElementById("err");

  function digitsOnly(v){ return String(v||"").replace(/\D/g,""); }

  function getCodeFromUrl(){
    const p = new URLSearchParams(window.location.search);
    return (p.get("pro") || p.get("code") || "").trim().toUpperCase();
  }

  function setUrlCode(code){
    const url = new URL(window.location.href);
    url.searchParams.set("pro", code);
    history.replaceState({}, "", url.toString());
  }

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){ errBox.style.display = "none"; errBox.textContent=""; }

  async function loadPro(code){
    clearErr();
    paybox.style.display = "none";
    howto.style.display = "none";
    proHint.textContent = "";

    if(!code){
      proName.textContent = "QR invalide";
      proHint.textContent = "Ouvre avec ?pro=CHEZASTOU (ou scanne un QR).";
      return;
    }

    proName.textContent = "Chargement‚Ä¶";
    proHint.textContent = "Code : " + code;

    const { data, error } = await sb
      .from("digiy_pay_pro")
      .select("business_code,business_name,wave_phone,is_active")
      .eq("business_code", code)
      .eq("is_active", true)
      .maybeSingle();

    if (error){
      proName.textContent = "Erreur Supabase";
      showErr(error.message || "Erreur inconnue");
      return;
    }
    if(!data){
      proName.textContent = "Professionnel introuvable";
      showErr("V√©rifie le code (ex: CHEZASTOU) ou l‚Äôactivation du pro.");
      return;
    }

    const phone = digitsOnly(data.wave_phone);
    proName.textContent = data.business_name || data.business_code;

    if(phone.length < 9){
      proHint.textContent = "Wave non configur√© pour ce pro.";
      showErr("Num√©ro Wave manquant. Renseigne wave_phone dans digiy_pay_pro.");
      return;
    }

    // Affichage identit√© paiement
    paybox.style.display = "block";
    proPhoneEl.textContent = "+" + phone;

    btnCall.href = "tel:+" + phone;

    btnCopy.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText("+" + phone);
        proHint.textContent = "‚úÖ Num√©ro copi√© : +" + phone;
      }catch(e){
        window.prompt("Copie le num√©ro Wave :", "+" + phone);
      }
    };

    howto.style.display = "block";
    howto.innerHTML =
      "üëâ Ouvre l‚Äôapp <b>Wave</b> ‚Üí <b>Payer</b> ‚Üí colle <b>+" + phone + "</b><br>" +
      "‚úÖ Paiement direct au pro ‚Ä¢ DIGIY = 0% commission";
  }

  btnLoad.addEventListener("click", ()=>{
    const code = (codeInput.value || "").trim().toUpperCase();
    if(code) setUrlCode(code);
    loadPro(code);
  });

  codeInput.addEventListener("keydown",(e)=>{
    if(e.key === "Enter") btnLoad.click();
  });

  // boot
  const code = getCodeFromUrl() || "CHEZASTOU";
  codeInput.value = code;
  loadPro(code);
</script>

</body>
</html>
